
I0Y0  EQU 0600H	;片选信号I0Y0的初始地址
I0Y1  EQU 0640H

MY8254_COUNT0 EQU I0Y0+00H*2
MY8254_COUNT1 EQU I0Y0+01H*2
MY8254_COUNT2 EQU I0Y0+02H*2
MY8254_MODE   EQU I0Y0+03H*2

MY8255_A      EQU I0Y1+00H*2
MY8255_B      EQU I0Y1+01H*2
MY8255_C      EQU I0Y1+02H*2
MY8255_MODE   EQU I0Y1+03H*2


STACK1 SEGMENT STACK
	DW 256 DUP(?)
STACK1 ENDS
CODE SEGMENT 
	ASSUME CS:CODE

START: 
		MOV DX,MY8254_MODE	;初始化8254的工作方式
		MOV AL,36H		;	注释一下，不明白；计数器0，方式3
		OUT DX,AL

		MOV DX,MY8254_COUNT0	;装入计数器初值
		MOV AL,0E8H
		OUT DX,AL
		MOV AL,03H
		OUT DX,AL
		
		MOV DX,MY8254_MODE	;初始化8254的工作方式
		MOV AL,076H		;	注释一下，不明白；计数器2，方式3
		OUT DX,AL

		MOV DX,MY8254_COUNT1	;装入计数器数值
		MOV AL,0E8H		;100分频
		OUT DX,AL
		MOV AL,03H
		OUT DX,AL
	
	
		MOV DX,MY8255_MODE
		MOV AL,89H
		OUT DX,AL

		MOV DX,MY8255_A
		MOV AL,81H		;LED灯显示1(RED)
		OUT DX,AL	
		CALL NINE
		MOV DX,MY8255_A
		MOV AL,82H		;LED灯显示1(RED)
		OUT DX,AL
		CALL TWO

		MOV DX,MY8255_A
		MOV AL,24H		;LED灯显示1(GREEN)
		OUT DX,AL
		CALL EIGHT

		MOV DX,MY8255_A
		MOV AL,44H		;LED灯显示1(YELLOW)
		OUT DX,AL
		CALL TWO
	
		MOV AH,01H;判断是否有按键按下
		INT 16H
		JZ START		;无按键则跳回继续循环，有责退出

QUIT:   MOV AX,4C00H		;结束程序退出
		INT 21H

;紧急处理		
INSTOP PROC NEAR

IN_STOP:	MOV DX,MY8255_C	;紧急处理程序
		IN AL,DX
		TEST AL,80H
		JNZ STOP
		JZ NOSTOP
		
STOP:	MOV AL,81H		;紧急东西处理程序
		MOV DX, MY8255_A
		OUT DX, AL
		MOV DX,MY8255_B
		MOV AL,77H
		OUT DX,AL
		MOV DX,MY8255_C
		IN AL,DX
		TEST AL,80H
		JNZ STOP
NOSTOP:
		RET	
INSTOP ENDP

INDO PROC NEAR

IN_DO:	MOV DX,MY8255_C	;紧急处理程序
		IN AL,DX
		TEST AL,40H
		JNZ DO
		JZ NODO
			
DO:		MOV AL,24H		;紧急南北处理程序
		MOV DX, MY8255_A
		OUT DX, AL
		MOV DX,MY8255_B
		MOV AL,77H
		OUT DX,AL
		MOV DX,MY8255_C
		IN AL,DX
		TEST AL,40H
		JNZ DO
NODO:		
		RET	
INDO ENDP
		
		

TST PROC NEAR			;下降沿检测子程序
		MOV DX,MY8255_C

HEAD:	IN AL,DX
		TEST AL,01H
		JZ TSTT
		JMP HEAD
TSTT:	IN AL,DX
		TEST AL,01H
		JZ TSTT
		RET	
TST ENDP


TWO PROC NEAR			;4――0S显示子程序


NEXT1:	CALL TST		;数码显示1
		MOV DX,MY8255_B
		MOV AL,06H
		OUT DX,AL
		CALL INSTOP ;调用暂停程序
		CALL INDO	;调用紧急通行程序

NEXT0:	CALL TST		;数码显示0
		MOV DX,MY8255_B
		MOV AL,3FH
		OUT DX,AL
		CALL INSTOP ;调用暂停程序
		CALL INDO	;调用紧急通行程序

		RET
TWO ENDP
EIGHT PROC NEAR			;4――0S显示子程序

NEXT77:	CALL TST		;数码显示7
		MOV DX,MY8255_B
		MOV AL,07H
		OUT DX,AL
		CALL INSTOP ;调用暂停程序
		CALL INDO	;调用紧急通行程序
		MOV DX,MY8255_C	;数码管切换
		IN AL,DX
		TEST AL,20H
;		JNZ NEXT9

NEXT66:	CALL TST		;数码显示6
		MOV DX,MY8255_B
		MOV AL,7DH
		OUT DX,AL
		CALL INSTOP ;调用暂停程序
		CALL INDO	;调用紧急通行程序
		
		MOV DX,MY8255_C	;数码管切换
		IN AL,DX
		TEST AL,20H
;		JNZ NEXT8

NEXT55:	CALL TST		;数码显示5
		MOV DX,MY8255_B
		MOV AL,6DH
		OUT DX,AL
		CALL INSTOP ;调用暂停程序
		CALL INDO	;调用紧急通行程序
		
		MOV DX,MY8255_C	;数码管切换
		IN AL,DX
		TEST AL,20H
;		JNZ NEXT7
		
NEXT44:	CALL TST		;数码显示4
		MOV DX,MY8255_B
		MOV AL,66H
		OUT DX,AL
		CALL INSTOP ;调用暂停程序
		CALL INDO	;调用紧急通行程序
		
		MOV DX,MY8255_C	;数码管切换
		IN AL,DX
		TEST AL,20H
;		JNZ NEXT6

NEXT33:	CALL TST		;数码显示3
		MOV DX,MY8255_B
		MOV AL,4FH
		OUT DX,AL
		CALL INSTOP ;调用暂停程序
		CALL INDO	;调用紧急通行程序
		
		MOV DX,MY8255_C	;数码管切换
		IN AL,DX
		TEST AL,20H
;		JNZ NEXT5

NEXT22:	CALL TST		;数码显示2
		MOV DX,MY8255_B
		MOV AL,5BH
		OUT DX,AL
		CALL INSTOP ;调用暂停程序
		CALL INDO	;调用紧急通行程序
		
		MOV DX,MY8255_C	;数码管切换
		IN AL,DX
		TEST AL,20H
;		JNZ NEXT4
		
NEXT11:	CALL TST		;数码显示1
		MOV DX,MY8255_B
		MOV AL,06H
		OUT DX,AL
		CALL INSTOP ;调用暂停程序
		CALL INDO	;调用紧急通行程序
		
		MOV DX,MY8255_C	;数码管切换
		IN AL,DX
		TEST AL,20H
;		JNZ NEXT3

NEXT00:	CALL TST		;数码显示0
		MOV DX,MY8255_B
		MOV AL,3FH
		OUT DX,AL
		CALL INSTOP ;调用暂停程序
		CALL INDO	;调用紧急通行程序
		MOV DX,MY8255_C	;数码管切换
		IN AL,DX
		TEST AL,20H
;		JNZ NEXT2

		RET
EIGHT ENDP

NINE PROC NEAR			;9――5S显示子程序
NEXT9:	CALL TST		;数码显示9
		MOV DX,MY8255_B
		MOV AL,6FH
		OUT DX,AL
		CALL INSTOP ;调用暂停程序
		CALL INDO	;调用紧急通行程序
		
		MOV DX,MY8255_C	;数码管切换
		IN AL,DX
		TEST AL,20H
;		JNZ NEXT77

NEXT8:	CALL TST		;数码显示8
		MOV DX,MY8255_B
		MOV AL,7FH
		OUT DX,AL
		CALL INSTOP ;调用暂停程序
		CALL INDO	;调用紧急通行程序
		
		MOV DX,MY8255_C	;数码管切换
		IN AL,DX
		TEST AL,20H
;		JNZ NEXT66

NEXT7:	CALL TST		;数码显示7
		MOV DX,MY8255_B
		MOV AL,07H
		OUT DX,AL
		CALL INSTOP ;调用暂停程序
		CALL INDO	;调用紧急通行程序
		
		MOV DX,MY8255_C	;数码管切换
		IN AL,DX
		TEST AL,20H
;		JNZ NEXT55

NEXT6:	CALL TST		;数码显示6
		MOV DX,MY8255_B	
		MOV AL,7DH
		OUT DX,AL
		CALL INSTOP ;调用暂停程序
		CALL INDO	;调用紧急通行程序
		
		MOV DX,MY8255_C	;数码管切换
		IN AL,DX
		TEST AL,20H
;		JNZ NEXT44

NEXT5:	CALL TST		;数码显示5
		MOV DX,MY8255_B
		MOV AL,6DH
		OUT DX,AL
		CALL INSTOP ;调用暂停程序
		CALL INDO	;调用紧急通行程序
		
		MOV DX,MY8255_C	;数码管切换
		IN AL,DX
		TEST AL,20H
;		JNZ NEXT33
		
NEXT4:	CALL TST		;数码显示4
		MOV DX,MY8255_B
		MOV AL,66H
		OUT DX,AL
		CALL INSTOP ;调用暂停程序
		CALL INDO	;调用紧急通行程序
		
		MOV DX,MY8255_C	;数码管切换
		IN AL,DX
		TEST AL,20H
	;	JNZ NEXT22

NEXT3:	CALL TST		;数码显示3
		MOV DX,MY8255_B
		MOV AL,4FH
		OUT DX,AL
		CALL INSTOP ;调用暂停程序
		CALL INDO	;调用紧急通行程序
		
		MOV DX,MY8255_C	;数码管切换
		IN AL,DX
		TEST AL,20H
;		JNZ NEXT11

NEXT2:	CALL TST		;数码显示2
		MOV DX,MY8255_B
		MOV AL,5BH
		OUT DX,AL
		CALL INSTOP ;调用暂停程序
		CALL INDO	;调用紧急通行程序
		
		MOV DX,MY8255_C	;数码管切换
		IN AL,DX
		TEST AL,20H
;		JNZ NEXT00

		RET
NINE ENDP

CODE ENDS
	END START
	